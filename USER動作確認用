# check_connection.yml
- name: Check SSH connection status
  hosts: all
  gather_facts: no
  tasks:

    - name: Test connection with ping module
      ansible.builtin.ping:
      register: ping_result
      ignore_errors: true

    - name: Mark result as variable
      set_fact:
        conn_status: "{{ 'success' if ping_result is succeeded else 'failed' }}"

# 只在 localhost 上做结果汇总
- name: Display connection results
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Print all successful connections
      debug:
        msg: "✅ {{ hostvars[item].inventory_hostname }} ({{ hostvars[item].ansible_user | default('N/A') }}) connected successfully"
      loop: "{{ groups['all'] }}"
      when: hostvars[item].conn_status == 'success'

    - name: Print all failed connections
      debug:
        msg: "❌ {{ hostvars[item].inventory_hostname }} ({{ hostvars[item].ansible_user | default('N/A') }}) failed to connect"
      loop: "{{ groups['all'] }}"
      when: hostvars[item].conn_status == 'failed'
