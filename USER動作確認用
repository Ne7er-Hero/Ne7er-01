# check_connection.yml
- name: Check SSH connection for all hosts
  hosts: all
  gather_facts: no
  tasks:

    - name: Test SSH connection using ping
      ansible.builtin.ping:
      register: ping_result
      ignore_errors: true

    - name: Set fact for connection status
      set_fact:
        conn_status: "{{ 'success' if ping_result is succeeded else 'failed' }}"

- name: Collect results
  hosts: localhost
  gather_facts: no
  vars:
    success_hosts: []
    failed_hosts: []
  tasks:

    - name: Gather successful hosts
      add_host:
        name: "{{ item }}"
        groups: success_group
      loop: "{{ groups['all'] }}"
      when: hostvars[item].conn_status == 'success'

    - name: Gather failed hosts
      add_host:
        name: "{{ item }}"
        groups: failed_group
      loop: "{{ groups['all'] }}"
      when: hostvars[item].conn_status == 'failed'

    - name: Show successful hosts (only if all succeeded)
      debug:
        msg: |
          ✅ All connections successful:
          {{ groups['success_group'] }}
      when:
        - groups['failed_group'] | length == 0
        - groups['success_group'] | length > 0

    - name: Show failed hosts (only if any failed)
      debug:
        msg: |
          ❌ Connection failed for:
          {{ groups['failed_group'] }}
      when: groups['failed_group'] | length > 0
